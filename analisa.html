<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Klaster</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Select2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tom Select CSS & JS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
  body {
    background: #eef2f4;
    font-family: "Segoe UI", sans-serif;
  }

  /* Card */
  .card {
    border-radius: 12px;
    overflow: hidden;
  }

  /* Header Tabel */
  .table thead th {
    background: #0077b6 !important;
    color: white !important;
    font-size: 0.75rem;
    text-align: center;
    vertical-align: middle;
  }

  .table td {
    font-size: 0.72rem;
    vertical-align: middle;
  }

  /* Sticky Header */
  .table-responsive {
    position: relative;
    max-height: 70vh;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
  }
  .table thead tr:nth-child(1) th {
    position: sticky;
    top: 0;
    z-index: 3;
  }
  .table thead tr:nth-child(2) th {
    position: sticky;
    top: 53px;
    z-index: 2;
  }

  /* Tombol */
  .btn {
    border-radius: 8px;
  }

  /* Keterangan warna grade */
  .legend-table td {
    padding: 4px 8px;
    font-size: 0.7rem;
    vertical-align: middle;
  }

  /* Modal */
  .modal-content {
    border-radius: 10px;
  }
</style>

  </head>

  <body>
  <div class="container-fluid py-4" style="max-width: 95%;">
  <div class="card shadow-sm border-0">
    <div class="card-body">
      
   <!-- Tombol & Filter -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4 no-print">
    
    <!-- Kiri: Tombol Kembali -->
    <a href="index.html" class="btn btn-outline-success shadow">
        <i class="fas fa-arrow-left me-1"></i> Kembali
    </a>

    <!-- Tengah: Pilih Bulan -->
    <div class="d-flex align-items-center gap-2">
        <label for="bulanSelect" class="fw-semibold text-success mb-0">
        <i class="fas fa-calendar-alt me-1"></i> Bulan
        </label>
        <select id="bulanSelect" class="form-select form-select border-success" style="max-width: 180px;">
        <option value="Juli">Semua Bulan</option>
        <option value="Jan">Januari</option>
        <option value="Feb">Februari</option>
        <option value="Mar">Maret</option>
        <option value="Apr">April</option>
        <option value="Mei">Mei</option>
        <option value="Juni">Juni</option>
        <option value="Juli">Juli</option>
        <option value="Agst">Agustus</option>
        <option value="Sept">September</option>
        <option value="Okt">Oktober</option>
        <option value="Nov">November</option>
        <option value="Des">Desember</option>
        </select>
    </div>

    <!-- Kanan: Tombol Simpan -->
    <button class="btn btn-success shadow" id="simpanMasalah">
        <i class="fas fa-save me-1"></i> Simpan Perubahan
    </button>

    </div>


      <!-- Awal Print Area -->
      <div id="printArea">
        <h5 id="judulKategori" class="fw-bold text-uppercase text-center"></h5>
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-hover align-middle text-nowrap" id="programTable">
            <thead class="table-success text-center align-middle">
              <tr>
                <th rowspan="2">No</th>
                <th rowspan="2" style="width: 300px;">Indikator Kerja</th>
                <th colspan="2">Bulan</th>
                <th rowspan="2" id="targetHeader" style="width: 70px;" class="text-wrap">% Target s/d Bulan ...</th>
                <th rowspan="2" style="width: 70px;" class="text-wrap">% CAKUPAN s/d Bulan <span id="cakupanBulan">...</span></th>
                <th rowspan="2" id="kesenjangan" style="width: 60px;" class="text-wrap">% Kesenjangan</th>
                <th rowspan="2" id="Tren" style="width: 70px;" class="text-wrap">TREN</th>
                <th rowspan="2" style="width: 30px;">Grade</th>
                <th rowspan="2" style="width: 220px;" class="text-wrap">Masalah</th>
                <th rowspan="2" style="width: 220px;" class="text-wrap">Analisa Penyebab Masalah</th>
                <th rowspan="2" style="width: 220px;" class="text-wrap">Rencana Tindak Lanjut</th>
                <th rowspan="2" style="width: 220px;" class="text-wrap">Hasil Tindak Lanjut</th>
              </tr>
              <tr>
                <th>Bulan Lalu</th>
                <th>Bulan Ini</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="25" class="text-center">Memuat data...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Akhir Print Area -->

      <!-- Keterangan Warna -->
      <div class="mt-4 no-print">
        <h6 class="fw-bold">Keterangan Warna Grade:</h6>
        <ul class="list-unstyled small">
          <li><span class="badge bg-primary">BIRU</span> : Capaian bulan ini lebih besar dari bulan lalu & kumulatif di atas target</li>
          <li class="mt-1"><span class="badge bg-primary">BIRU</span> : Capaian bulan ini sama dengan bulan lalu & kumulatif di atas target</li>
          <li class="mt-1"><span class="badge bg-success">HIJAU</span> : Capaian bulan ini lebih kecil dari bulan lalu & kumulatif di atas target</li>
          <li class="mt-1"><span class="badge bg-warning text-dark">KUNING</span> : Capaian bulan ini lebih besar dari bulan lalu & kumulatif di bawah target</li>
          <li class="mt-1"><span class="badge bg-danger">MERAH</span> : Capaian bulan ini lebih kecil atau sama dengan bulan lalu & kumulatif di bawah target</li>
        </ul>
      </div>

    </div>
  </div>
</div>


    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
   <script>
  const endpoint =
    "https://script.google.com/macros/s/AKfycbyXUb1qcb9YTr8nv4C1Ad2p2ifqosTbRBF0B-rg8bb1f2Tc9hy4LMwrIaZia1YIkPMD6w/exec";

  const bulanKeys = [
    "Jan", "Feb", "Mar", "Apr", "Mei", "Juni", "Juli", "Agst", "Sept", "Okt", "Nov", "Des",
  ];

  const labelMap = {
    Jan: "Januari", Feb: "Februari", Mar: "Maret", Apr: "April", Mei: "Mei",
    Juni: "Juni", Juli: "Juli", Agst: "Agustus", Sept: "September",
    Okt: "Oktober", Nov: "November", Des: "Desember",
  };

  const masalahMap = {
    Januari: "Masalah_Jan", Februari: "Masalah_Feb", Maret: "Masalah_Mar",
    April: "Masalah_Apr", Mei: "Masalah_Mei", Juni: "Masalah_Jun",
    Juli: "Masalah_Jul", Agustus: "Masalah_Agu", September: "Masalah_Sep",
    Oktober: "Masalah_Okt", November: "Masalah_Nov", Desember: "Masalah_Des",
  };

  const analisaMap = {
    Januari: "Analisa_masalah_jan", Februari: "Analisa_Masalah_Feb", Maret: "Analisa_Masalah_Mar",
    April: "Analisa_Masalah_Apr", Mei: "Analisa_Masalah_Mei", Juni: "Analisa_Masalah_Jun",
    Juli: "Analisa_Masalah_Jul", Agustus: "Analisa_Masalah_Agu", September: "Analisa_Masalah_Sep",
    Oktober: "Analisa_Masalah_Okt", November: "Analisa_Masalah_Nov", Desember: "Analisa_Masalah_Des",
  };

  const rtlMap = {
    Januari: "RTL_Jan", Februari: "RTL_Feb", Maret: "RTL_Mar",
    April: "RTL_Apr", Mei: "RTL_Mei", Juni: "RTL_Jun",
    Juli: "RTL_Jul", Agustus: "RTL_Agu", September: "RTL_Sep",
    Oktober: "RTL_Okt", November: "RTL_Nov", Desember: "RTL_Des",
  };

  const hasilMap = {
    Januari: "Hasil_Jan", Februari: "Hasil_Feb", Maret: "Hasil_Mar",
    April: "Hasil_Apr", Mei: "Hasil_Mei", Juni: "Hasil_Jun",
    Juli: "Hasil_Jul", Agustus: "Hasil_Agus", September: "Hasil_Sep",
    Oktober: "Hasil_Okt", November: "Hasil_Nop", Desember: "Hasil_Des",
  };

  let originalData = [];
  let selectedBulan = "Juli";
  let selectedkategori = "Semua";

  function getQueryParam(param) {
    return new URLSearchParams(window.location.search).get(param);
  }

  // Fungsi umum untuk update data (dipakai pada semua textarea)
  async function updateData(id, bulan, nilai) {
    if (!id || !bulan) return;
    try {
      const res = await fetch(`${endpoint}?action=update&id=${encodeURIComponent(id)}&bulan=${encodeURIComponent(bulan)}&nilai=${encodeURIComponent(nilai)}`);
      const result = await res.json();
      if (!result.success) alert("Gagal memperbarui data: " + result.message);
    } catch (err) {
      console.error("Update error:", err);
      alert("Terjadi kesalahan saat menyimpan data.");
    }
  }

  function autoResizeTextarea(textarea) {
    textarea.style.height = "auto";
    textarea.style.height = textarea.scrollHeight + "px";
  }

  // Render tabel berdasarkan data dan bulan terpilih
  function renderTable(data, bulan) {
    const tbody = document.getElementById("tableBody");
    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="25" class="text-center">Tidak ada data tersedia.</td></tr>`;
      return;
    }

    const idx = bulanKeys.indexOf(bulan);
    const bulanIniKey = bulanKeys[idx];
    const bulanLaluKey = bulanKeys[idx - 1] || null;
    const labelBulan = labelMap[bulanIniKey];
    const kolomMasalah = masalahMap[labelBulan] || "Masalah_Jan";
    const kolomAnalisa = analisaMap[labelBulan] || "Analisa_masalah_jan";
    const kolomRTL = rtlMap[labelBulan] || "RTL_jan";

    // Update header dinamis
    const thead2th = document.querySelectorAll("thead tr:nth-child(2) th");
    if(thead2th.length >= 2) {
      thead2th[0].innerText = bulanLaluKey ? labelMap[bulanLaluKey] : "-";
      thead2th[1].innerText = labelMap[bulanIniKey];
    }

    document.getElementById("targetHeader").innerText = `% Target s/d Bulan ${labelBulan}`;
    document.getElementById("cakupanBulan").innerText = labelBulan;

    // Filter kategori
    const filtered = selectedkategori === "Semua"
      ? data
      : data.filter(d => (d.kategori || "Tanpa kategori") === selectedkategori);

    // Group by Sub
    const grouped = filtered.reduce((acc, row) => {
      const sub = row.Sub || "Tanpa Sub";
      if (!acc[sub]) acc[sub] = [];
      acc[sub].push(row);
      return acc;
    }, {});

    let rows = "";
    let counter = 1;

    for (const sub in grouped) {
      const rowsInSub = grouped[sub];
      const program = rowsInSub[0].Induk || "";

      rows += `
        <tr><td colspan="13" class="fw-bold text-danger" style="background-color: #f8d7da;">${program}</td></tr>
        <tr><td colspan="13" class="fw-semibold text-primary" style="background-color: #e2e3f3;">${sub}</td></tr>
      `;

      rowsInSub.forEach(row => {
        const indikator = row["Indikator Kerja"] || "-";
        const bulanIniVal = parseFloat(row[bulanIniKey]);
        const bulanLaluVal = bulanLaluKey ? parseFloat(row[bulanLaluKey]) : 0;
        const targetSasaran = parseFloat(row["Target Sasaran"]) || 0;
        const bulanKe = idx + 1;

        const targetSD = targetSasaran
          ? (((targetSasaran / 12) * bulanKe) / targetSasaran * 100).toFixed(2)
          : "-";

        let totalCapaian = 0;
        for (let i = 0; i <= idx; i++) {
          const val = parseFloat(row[bulanKeys[i]]);
          if (!isNaN(val)) totalCapaian += val;
        }

        const cakupanSD = targetSasaran
          ? ((totalCapaian / targetSasaran) * 100).toFixed(2)
          : "-";

        const masalahBulanIni = row[kolomMasalah] || "";
        const analisaBulanIni = row[kolomAnalisa] || "";
        const RTLBulanIni = row[kolomRTL] || "";

        // Hitung gap & tren
        let gap = "-";
        let tren = "<i class='bi bi-arrow-right-circle-fill fs-4 text-dark'></i>";
        let trenClass = "";

        const cakupanVal = parseFloat(cakupanSD);
        const targetVal = parseFloat(targetSD);

        if (!isNaN(cakupanVal) && !isNaN(targetVal)) {
          const selisihGap = Math.round(cakupanVal - targetVal);
          gap = `${selisihGap > 0 ? "+" : ""}${selisihGap}`;
        }

        if (!isNaN(bulanIniVal) && !isNaN(bulanLaluVal)) {
          const selisihBulan = (bulanIniVal - bulanLaluVal).toFixed(2);
          if (selisihBulan > 0) {
            tren = "<i class='bi bi-arrow-up-circle-fill fs-4 text-dark'></i>";
            trenClass = " text-white";
          } else if (selisihBulan < 0) {
            tren = "<i class='bi bi-arrow-down-circle-fill fs-4 text-dark'></i>";
            trenClass = " text-white";
          }
        }

        // Grade coloring
        let grade = "-";
        let gradeClass = "";

        if (!isNaN(bulanIniVal) && !isNaN(bulanLaluVal) && !isNaN(cakupanSD) && !isNaN(targetSD)) {
          const capaianNaik = bulanIniVal > bulanLaluVal;
          const capaianTurun = bulanIniVal < bulanLaluVal;
          const capaianSama = bulanIniVal === bulanLaluVal;
          const selisihCakupan = parseFloat(cakupanSD) - parseFloat(targetSD);

          if ((capaianNaik || capaianSama) && selisihCakupan >= 0) {
            grade = "";
            gradeClass = "bg-primary text-white";
          } else if (capaianTurun && selisihCakupan >= 0) {
            grade = "";
            gradeClass = "bg-success text-white";
          } else if (capaianNaik && selisihCakupan < 0) {
            grade = "";
            gradeClass = "bg-warning text-dark";
          } else if ((capaianTurun || capaianSama) && selisihCakupan < 0) {
            grade = "";
            gradeClass = "bg-danger text-white";
          }
        }

        rows += `
          <tr>
            <td class="text-center">${counter++}</td>
            <td class="text-wrap" title="${indikator}">${indikator}</td>
            <td class="text-wrap text-center">${isNaN(bulanLaluVal) ? "-" : bulanLaluVal}</td>
            <td class="text-wrap text-center">${isNaN(bulanIniVal) ? "-" : bulanIniVal}</td>
            <td class="text-wrap text-center">${targetSD}</td>
            <td class="text-wrap text-center">${cakupanSD}</td>
            <td class="text-center">${gap}</td>
            <td class="text-center ${trenClass}">${tren}</td>
            <td class="${gradeClass} text-center fw-semibold">${grade}</td>
            <td><textarea class="form-control form-control-sm masalah-textarea" rows="2" data-id="${row["No"]}" data-bulan="${kolomMasalah}">${masalahBulanIni}</textarea></td>
            <td><textarea class="form-control form-control-sm analisa-textarea" style="overflow:hidden; resize:none;" rows="2" data-id="${row["No"]}" data-bulan="${kolomAnalisa}">${analisaBulanIni}</textarea></td>
            <td><textarea class="form-control form-control-sm rtl-textarea" style="overflow:hidden; resize:none;" rows="2" data-id="${row["No"]}" data-bulan="${kolomRTL}">${RTLBulanIni}</textarea></td>
            <td><textarea class="form-control form-control-sm hasil-textarea" style="overflow:hidden; resize:none;" rows="2" data-id="${row["No"]}" data-bulan="Hasil_${bulanIniKey}">${row["Hasil_" + bulanIniKey] || ""}</textarea></td>
          </tr>
        `;
      });

    }
    tbody.innerHTML = rows;

    // Setup autoResize dan event listener untuk semua textarea dalam tbody
    const allTextareas = tbody.querySelectorAll("textarea");
    allTextareas.forEach(textarea => {
      autoResizeTextarea(textarea);
      textarea.addEventListener("input", () => autoResizeTextarea(textarea));
      textarea.addEventListener("change", () => {
        const id = textarea.dataset.id;
        const bulan = textarea.dataset.bulan;
        const nilai = textarea.value;
        updateData(id, bulan, nilai);
      });
    });
  }

  window.onload = async () => {
    // Ambil kategori dari URL jika ada
    const kategoriFromURL = getQueryParam("kategori");
    if (kategoriFromURL) {
      selectedkategori = decodeURIComponent(kategoriFromURL);
      const judulEl = document.getElementById("judulKategori");
      if (judulEl) {
        judulEl.innerHTML = `IDENTIFIKASI, ANALISA MASALAH DAN RENCANA TINDAK LANJUT<br>PROGRAM ${selectedkategori.toUpperCase()} - PKP 2025`;
      }
    }

    // Tampilkan spinner dulu
    const tbody = document.getElementById("tableBody");
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="25" class="text-center">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Memuat...</span>
            </div>
            <div>Memuat data...</div>
          </td>
        </tr>
      `;
    }

    try {
      const res = await fetch(endpoint);
      if (!res.ok) throw new Error("Network response was not ok");
      const data = await res.json();
      originalData = data;
      renderTable(originalData, selectedBulan);
    } catch (err) {
      if (tbody) {
        tbody.innerHTML = "<tr><td colspan='25' class='text-center text-danger'>Gagal memuat data</td></tr>";
      }
      console.error("Fetch error:", err);
    }
  };

  // Event handler untuk change bulan
  document.getElementById("bulanSelect")?.addEventListener("change", function () {
    const bulan = this.value;
    if (bulanKeys.includes(bulan)) {
      selectedBulan = bulan;
      renderTable(originalData, selectedBulan);
    }
  });

  // Event handler untuk change kategori
  document.getElementById("kategoriSelect")?.addEventListener("change", function () {
    selectedkategori = this.value;
    renderTable(originalData, selectedBulan);
  });
</script>


    <script>
      document
        .getElementById("simpanMasalah")
        .addEventListener("click", function () {
          const textareas = document.querySelectorAll(".masalah-textarea");
          const analisaAreas = document.querySelectorAll(".analisa-textarea");
          const rtlAreas = document.querySelectorAll(".rtl-textarea"); // Tambahan untuk RTL
          const hasilAreas = document.querySelectorAll(".hasil-textarea");

          const updates = [];

          const bulanDipilih = document.getElementById("bulanSelect").value;
          const labelBulan = labelMap[bulanDipilih];
          const kolomMasalahDipilih = masalahMap[labelBulan];
          const kolomAnalisaDipilih = analisaMap[labelBulan];
          const kolomRTLDipilih = rtlMap[labelBulan]; // Map RTL

          // Masalah
          textareas.forEach((textarea) => {
            const id = textarea.getAttribute("data-id");
            const kolomBulan = textarea.getAttribute("data-bulan");

            if (kolomBulan !== kolomMasalahDipilih) return;

            const nilai = textarea.value.trim();
            if (id && kolomBulan && nilai !== "") {
              updates.push({ id, bulan: kolomBulan, nilai });
            }
          });

          // Analisa
          analisaAreas.forEach((textarea) => {
            const id = textarea.getAttribute("data-id");
            const kolomBulan = textarea.getAttribute("data-bulan");

            if (kolomBulan !== kolomAnalisaDipilih) return;

            const nilai = textarea.value.trim();
            if (id && kolomBulan && nilai !== "") {
              updates.push({ id, bulan: kolomBulan, nilai });
            }
          });

          // RTL
          rtlAreas.forEach((textarea) => {
            const id = textarea.getAttribute("data-id");
            const kolomBulan = textarea.getAttribute("data-bulan");

            if (kolomBulan !== kolomRTLDipilih) return;

            const nilai = textarea.value.trim();
            if (id && kolomBulan && nilai !== "") {
              updates.push({ id, bulan: kolomBulan, nilai });
            }
          });

          // Hasil
          hasilAreas.forEach((textarea) => {
            const id = textarea.getAttribute("data-id");
            const kolomBulan = textarea.getAttribute("data-bulan");

            // Pastikan kolom bulan sesuai Hasil_[BulanIni]
            if (!kolomBulan.includes(`Hasil_${bulanDipilih}`)) return;

            const nilai = textarea.value.trim();
            if (id && kolomBulan && nilai !== "") {
              updates.push({ id, bulan: kolomBulan, nilai });
            }
          });

          if (updates.length === 0) {
            Swal.fire(
              "Tidak ada perubahan",
              "Silakan isi data terlebih dahulu",
              "info"
            );
            return;
          }

          // Kirim update satu per satu
          Promise.all(
            updates.map((item) =>
              fetch(
                `${endpoint}?action=update&id=${encodeURIComponent(
                  item.id
                )}&bulan=${encodeURIComponent(
                  item.bulan
                )}&nilai=${encodeURIComponent(item.nilai)}`
              ).then((res) => res.json())
            )
          )
            .then((results) => {
              const gagal = results.filter((r) => !r.success);
              if (gagal.length > 0) {
                Swal.fire(
                  "Sebagian Gagal",
                  `${gagal.length} data gagal disimpan.`,
                  "warning"
                );
              } else {
                Swal.fire(
                  "Tersimpan!",
                  "Seluruh perubahan berhasil disimpan.",
                  "success"
                );
              }
            })
            .catch((err) => {
              console.error("Kesalahan penyimpanan:", err);
              Swal.fire(
                "Error",
                "Terjadi kesalahan saat menyimpan data.",
                "error"
              );
            });
        });
    </script>
  </body>
</html>
